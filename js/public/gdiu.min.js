var defaultFormat={subheading:{pattern:/## (.*)/g,format:"<h2>$1</h2>"},heading:{pattern:/# (.*)/g,format:"<h1>$1</h1>"},italic:{pattern:/\b_(.*?)_\b/g,format:"<em>$1</em>"},bold:{pattern:/\*\b(.*?)\b\*/g,format:"<strong>$1</strong>"},"image-classed":{pattern:/!\[(.+?)\]\((\S+?)\)<(.*?)>/g,format:"<div class='img $3' alt='$1' style='background-image: url(\"$2\");'>$1</div>"},image:{pattern:/!\[(.+?)\]\((\S+?)\)/g,format:"<div class='img' alt='$1' style='background-image: url(\"$2\");'>$1</div>"},"link-same-tab":{pattern:/\[(.+?)\]\(=(\S+?)\)/g,format:"<a href='$2'>$1</a>"},link:{pattern:/\[(.+?)\]\((\S+?)\)/g,format:"<a href='$2'>$1</a>"},paragraph:{pattern:/([^\n][\s\S]*?)(?:\n\n|$)/g,format:"<p>$1</p>\n"},linebreak:{pattenr:/\\\\/g,format:"<br/>"},"nonbreaking-space":{pattenr:/<>/g,format:"&nbsp;"}};function muProcess(e,t){void 0===t&&(t=defaultFormat);var n=e;for(var r in t){var l=t[r].pattern,a=t[r].format;n=n.replace(l,a)}return n}function regexEscape(e){return e.replace(/[\.\*\+\?\^\$\{\}\(\)\|\[\]\\]/g,"\\$&")}var content={directory:"/wc",fileExtension:"xml",listingFileName:"listing",formatTag:"!format"},attribute={remote:"get",query:"get-query",list:"list",multipleRemote:"get-multi",maxCount:"max-items",rowMaxCount:"row-max",filterBy:"filter-by",injectLink:"inj-link",injectSource:"inj-src"},filter={defaultDateSeparator:"-",dateInFuture:function(e,t){void 0===t&&(t=filter.defaultDateSeparator),e=e.substr(e.lastIndexOf("/")+1),console.log(e);var n=e.split(t),r=parseInt(n[0])-1,l=parseInt(n[1]),a=parseInt(n[2])+2e3,i=new Date(Date.now()),o=i.getMonth(),c=i.getDate(),u=i.getFullYear();return!(a<u)&&(u<a||!(r<o)&&(o<r||!(l<c)))}},get={cache:{},fileContents:function(e,t,n){if(null==get.cache[e]){var r=new XMLHttpRequest;r.onreadystatechange=function(){4==r.readyState&&(200==r.status?(null==get.cache[e]?(console.log("(get.fileContents) Read http response for '"+e+"'"),get.cache[e]=r.responseText):console.log("(get.fileContents) Ignore http response for '"+e+"'"),t(get.cache[e])):n())},r.open("GET",e,!0),r.send(null)}else console.log("(get.fileContents) Returned cached value for '"+e+"'"),t(get.cache[e])}},xml={cache:{},nodeType:{text:3},toObject:function(e,t,n){if(null!=xml.cache[n])return console.log("(xml.toObject) Return cached value for XML at '"+n+"'"),xml.cache[n];e=e.replace(/ & /g," &amp; ");function c(e,t){if(0<t.length)if(0<=t.indexOf(content.formatTag)&&(t=muProcess(t=t.replace(content.formatTag,"").trim())),null==l[e])l[e]=t;else{if(null==l[e].push){var n=l[e];l[e]=[n]}l[e].push(t)}}var r=(new DOMParser).parseFromString(e,"text/xml"),l={getLink:t},u=function(e,t,n){var r=0<n&&e.nodeName.indexOf("#")<0?t+(""==t?"":"/")+e.nodeName:t;if(e instanceof Text){var l=e.nodeValue.trim();c(r,l)}if(e instanceof Element&&e.hasAttributes())for(var a=0;a<e.attributes.length;a++){var i=e.attributes.item(a),o=r+"/"+i.nodeName;c(o,i.nodeValue.trim())}e.hasChildNodes()&&e.childNodes.forEach(function(e){u(e,r,n+1)})};return u(r.getRootNode(),"",-1),xml.cache[n]=l,console.log("(xml.toObject) Parse XML from '"+n+"'"),l}},inject={variablePrefix:"$",preventLoadPattern:/`\b(\S+)\b/g,queue:{},listValueName:"listValue",listIndexName:"listIndex",hasContentName:"hasContent",getVariablePattern:function(e){return new RegExp(""+regexEscape(inject.variablePrefix)+e,"g")},fill:function(t,n){function e(){var a=n[r],e=t.querySelectorAll("["+attribute.list+"='"+r+"']");i=Array.isArray(a)?(e.forEach(function(e,t){var n=e.outerHTML;e.removeAttribute(attribute.list);var r=e.outerHTML,l="";a.forEach(function(e,t){var n=r.replace(o,e).replace(c,""+t);l+=n+"\n"}),i=i.replace(n,l)}),i.replace(inject.getVariablePattern(r),a.toString())):(e.forEach(function(e,t){var n=e.outerHTML;e.removeAttribute(attribute.list);var r=e.outerHTML.replace(o,a).replace(c,"0");i=i.replace(n,r)}),i.replace(inject.getVariablePattern(r),a))}var i=t.outerHTML,o=inject.getVariablePattern(inject.listValueName),c=inject.getVariablePattern(inject.listIndexName);for(var r in n)e();i=(i=i.replace(inject.getVariablePattern(inject.hasContentName),"true")).replace(inject.preventLoadPattern,"$1"),t.outerHTML=i},fillFrom:function(t,n){var r={url:content.directory+"/"+t+"."+content.fileExtension,target:n,result:null,done:!1};get.fileContents(r.url,function(e){r.result=xml.toObject(e,t,r.url),inject.fill(n,r.result),r.done=!0},function(){console.error("(inject.from) Failed to get file contents at "+r.url),r.done=!0})},fillAllRemote:function(){var e=document.querySelectorAll("["+attribute.remote+"]");console.log("(inject.fillAllRemote) Starting inject for "+e.length+" elements..."),e.forEach(function(e){var t=e.getAttribute(attribute.remote);inject.fillFrom(t,e),e.removeAttribute(attribute.remote)})},fillFromMultiple:function(o,c,u){var f=content.directory+"/"+o+"/"+content.listingFileName+"."+content.fileExtension;get.fileContents(f,function(e){var t=xml.toObject(e,o,f)["item/src"];null==t.push&&(t=[t]);var n=[];null==c?n=t:t.forEach(function(e){c(e)&&n.push(e)});var r=[],l=u.outerHTML.trim(),a=u.parentElement;a.removeChild(u);var i=document.createElement("template");n.forEach(function(e){i.innerHTML=l;var t=a.appendChild(i.content.firstChild),n={url:content.directory+"/"+o+"/"+e+"."+content.fileExtension,getURL:o+"/"+e,result:null,done:!1,target:t};r.push(n)}),r.forEach(function(t){get.fileContents(t.url,function(e){t.result=xml.toObject(e,t.getURL,t.url),inject.fill(t.target,t.result),t.done=!0},function(){console.error("(inject.fillFromMultiple) Failed to get file contents at '"+t.url+"'"),a.removeChild(t.target),t.done=!0})})},function(){console.error("(inject.fillFromMultiple) Failed to get listing file at '"+f+"'")})},fillAllMultiple:function(){var e=document.querySelectorAll("["+attribute.multipleRemote+"]");console.log("(inject.fillAllMultiple) Starting multi-inject for "+e.length+" elements..."),e.forEach(function(e){var t=e.getAttribute(attribute.multipleRemote),n=e.getAttribute(attribute.filterBy),r=null;null!=n&&null!=filter[n]&&(r=filter[n]),inject.fillFromMultiple(t,r,e),e.removeAttribute(attribute.multipleRemote)})}};inject.fillAllRemote(),inject.fillAllMultiple();